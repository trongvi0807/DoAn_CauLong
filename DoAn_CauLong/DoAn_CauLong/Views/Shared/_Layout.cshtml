@using System.Web.Mvc
@{
    ViewBag.Title = "Cửa Hàng Cầu Lông Online";
}
<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cửa Hàng Cầu Lông Online</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css" />
    <link href="@Url.Content("~/Content/bootstrap.css")" rel="stylesheet" />
    <link href="@Url.Content("~/Content/Site.css")" rel="stylesheet" />
</head>

<body>
    <header class="main-header">
        <div class="header-top">
            <div class="logo">
                <a href="@Url.Action("Index", "Home")">

                    <img src="@Url.Content("~/Content/images/HUIT.jpg")"
                         alt="Logo Cửa Hàng Cầu Lông" />
                </a>
            </div>

            <form action="@Url.Action("TimKiem", "SanPham")" method="get" class="search-form search-absolute">

                <input type="text" name="keyword" placeholder="Tìm kiếm sản phẩm..." class="search-input" />
                <button type="submit" class="search-btn" aria-label="Tìm kiếm">
                    <i class="fa-solid fa-magnifying-glass"></i>
                </button>
            </form>

            <div class="header-actions">
                <div class="account-section">
                    @if (Session["MaTaiKhoan"] == null)
                    {
                        <div class="auth-buttons">
                            <a href="@Url.Action("DangNhap", "TaiKhoan")" class="auth-btn login-btn">
                                <i class="fa-solid fa-user"></i>
                                <span>Đăng nhập</span>
                            </a>
                            <a href="@Url.Action("DangKy", "TaiKhoan")" class="auth-btn register-btn">
                                <span>Đăng ký</span>
                            </a>
                        </div>
                    }
                    else
                    {
                        int maQuyen = 0;
                        if (Session["MaQuyen"] != null)
                        {
                            maQuyen = (int)Session["MaQuyen"];
                        }

                        <div class="user-dropdown">
                            <button class="user-btn" type="button">
                                <i class="fa-solid fa-user"></i>
                                <span>Xin chào, @Session["HoTen"]</span>
                                <i class="fa-solid fa-chevron-down"></i>
                            </button>
                            <div class="user-menu">
                                @if (maQuyen == 1)
                                {
                                    <a href="@Url.Action("Index", "QuanLySanPham")" class="user-menu-item" style="font-weight: bold; background: #eee;">
                                        <i class="fa-solid fa-boxes-stacked"></i>
                                        Quản lý Sản phẩm
                                    </a>
                                    <a href="@Url.Action("Index", "QuanLyTaiKhoan")" class="user-menu-item" style="font-weight: bold; background: #eee;">
                                        <i class="fa-solid fa-boxes-stacked"></i>
                                        Quản lý tài khoản
                                    </a>
                                    <a href="@Url.Action("Index", "QuanLyDonHang")" class="user-menu-item" style="font-weight: bold; background: #eee;">
                                        <i class="fa-solid fa-file-invoice"></i>
                                        Quản lý Đơn hàng
                                    </a>
                                    <a href="@Url.Action("Index", "QuanLyKhuyenMai")" class="user-menu-item" style="font-weight: bold; background: #eee;">
                                        <i class="fa-solid fa-tags"></i>
                                        Quản lý Khuyến mãi
                                    </a>
                                    @* Thêm các link quản lý khác tại đây *@
                                    <hr style="margin: 5px 0;" />
                                    <div class="cart-section">
                                        <a href="@Url.Action("Dashboard", "QuanLySanPham")" class="user-menu-item" style="font-weight: bold; background: #eee;">
                                            <i class="fa-solid fa-chart-line"></i> Dashboard
                                        </a>
                                    </div>
                                    <hr style="margin: 5px 0;" />
                                    // tạo view cho phần thông báo và gửi cảnh báo về nếu đánh giá <=2
                                    <div class="cart-section">
                                        <a href="@Url.Action("ThongBao", "QuanLyThongBao")"
                                           class="user-menu-item"
                                           style="font-weight: bold; background: #eee;">
                                            <i class="fa-solid fa-bell"></i>
                                            <span class="cart-text">Thông Báo</span>
                                            <span class="cart-count">@Html.Action("SoThongBao", "QuanLyThongBao")</span>
                                            @* không thể hiển thị số lượng thông báo *@
                                        </a>
                                    </div>
                                    // tạo view cho phần thông báo và gửi cảnh báo về nếu đánh giá <=2
                                }
                                @if (maQuyen == 2)
                                {
                                    <a href="@Url.Action("Index", "QuanLySanPham")" class="user-menu-item" style="font-weight: bold; background: #eee;">
                                        <i class="fa-solid fa-boxes-stacked"></i>
                                        Quản lý Sản phẩm
                                    </a>
                                    <a href="@Url.Action("Index", "QuanLyDonHang")" class="user-menu-item" style="font-weight: bold; background: #eee;">
                                        <i class="fa-solid fa-file-invoice"></i>
                                        Quản lý Đơn hàng
                                    </a>
                                    @* Thêm các link quản lý khác tại đây *@
                                    <hr style="margin: 5px 0;" /> // tạo view cho phần thông báo và gửi cảnh báo về nếu đánh giá <=2
                                    <div class="cart-section">
                                        <a href="@Url.Action("ThongBao", "QuanLyThongBao")"
                                           class="user-menu-item"
                                           style="font-weight: bold; background: #eee;">
                                            <i class="fa-solid fa-bell"></i>
                                            <span class="cart-text">Thông Báo</span>
                                            <span class="cart-count">@Html.Action("SoThongBao", "QuanLyThongBao")</span>
                                            @* không thể hiển thị số lượng thông báo *@
                                        </a>
                                    </div>
                                }

                                @* Chức năng chung cho mọi tài khoản đã đăng nhập *@
                                <a href="@Url.Action("ThongTin", "TaiKhoan")" class="user-menu-item">
                                    <i class="fa-solid fa-user-circle"></i>
                                    Thông tin tài khoản
                                </a>
                                <a href="@Url.Action("DoiMatKhau", "TaiKhoan")" class="user-menu-item">
                                    <i class="fa-solid fa-user-circle"></i>
                                    Đổi mật khẩu
                                </a>
                                <a href="@Url.Action("Index", "DonHang")" class="user-menu-item">
                                    <i class="fa-solid fa-clipboard-list"></i>
                                    Đơn hàng của tôi
                                </a>
                                <a href="@Url.Action("DangXuat", "TaiKhoan")" class="user-menu-item">
                                    <i class="fa-solid fa-right-from-bracket"></i>
                                    Đăng xuất
                                </a>
                            </div>
                        </div>
                    }
                </div>

                <div class="cart-section">
                    <a href="@Url.Action("ViewCart", "Home")" class="cart-btn">

                        <i class="fa-solid fa-cart-shopping"></i>
                        <span class="cart-text">Giỏ hàng</span>
                        <span class="cart-count">
                            @(Session["GioHangCount"] ?? 0)
                        </span>
                    </a>
                </div>
            </div>
        </div>

        <nav class="main-nav">
            <ul>
                <li><a href="@Url.Action("Index", "Home")">TRANG CHỦ</a></li>


                <li class="mega-menu-item">
                    <a href="@Url.Action("Index", "SanPham")">
                        SẢN PHẨM
                        <i class="fa-solid fa-chevron-down"></i>
                    </a>

                    <div class="mega-submenu">
                        <div class="sidebar-categories">

                            <h3>DANH MỤC SẢN PHẨM</h3>

                            <a href="@Url.Action("Index", "SanPham", new { loai = "Vot" })"
                               class="main-cat active" data-loai="Vot">

                                VỢT CẦU LÔNG
                                <i class="fa-solid fa-chevron-right"></i>
                            </a>

                            <a href="@Url.Action("Index", "SanPham", new { loai = "Giay" })"
                               class="main-cat" data-loai="Giay">
                                GIÀY CẦU LÔNG

                                <i class="fa-solid fa-chevron-right"></i>
                            </a>
                            <a href="@Url.Action("Index", "SanPham", new { loai = "AoQuan" })"
                               class="main-cat" data-loai="AoQuan">
                                ÁO QUẦN THỂ THAO
                                <i class="fa-solid fa-chevron-right"></i>

                            </a>
                            <a href="@Url.Action("Index", "SanPham", new { loai = "PhuKien" })"
                               class="main-cat" data-loai="PhuKien">

                                PHỤ KIỆN CẦU LÔNG
                                <i class="fa-solid fa-chevron-right"></i>
                            </a>
                        </div>


                        <div class="mega-contents-wrapper">
                            <div class="mega-content" data-loai="Giay">
                                <div class="product-brands-grid">
                                    <div class="brand-column">

                                        <p class="brand-title">GIÀY YONEX</p>
                                        <a href="@Url.Action("Index", "SanPham", new { hang = "Yonex", loai = "Giay", ten = "65" })">Giày Yonex 65</a>

                                        <a href="@Url.Action("Index", "SanPham", new { hang = "Yonex", loai = "Giay", ten = "Aerus" })">Giày Yonex Aerus</a>
                                        <a href="@Url.Action("Index", "SanPham", new { hang = "Yonex", loai = "Giay", ten = "Eclipsion" })">Giày Yonex Eclipsion</a>

                                    </div>

                                    <div class="brand-column">
                                        <p class="brand-title"><a href="@Url.Action("Index", "SanPham", new { hang = "Lining", loai = "Giay" })">GIÀY LINING</a></p>

                                    </div>

                                    <div class="brand-column">

                                        <p class="brand-title"><a href="@Url.Action("Index", "SanPham", new { hang = "Victor", loai = "Giay" })">GIÀY VICTOR</a></p>
                                    </div>

                                    <div class="brand-column">

                                        <p class="brand-title"><a href="@Url.Action("Index", "SanPham", new { hang = "Mizuno", loai = "Giay" })">GIÀY MIZUNO</a></p>

                                    </div>
                                </div>
                            </div>


                            <div class="mega-content active" data-loai="Vot">
                                <div class="product-brands-grid">

                                    <div class="brand-column">
                                        <p class="brand-title"><a href="@Url.Action("Index", "SanPham", new { hang = "Yonex", loai = "Vot" })">VỢT YONEX</a></p>

                                        <a href="@Url.Action("Index", "SanPham", new { hang = "Yonex", loai = "Vot", ten = "Astrox" })">Vợt Yonex Astrox</a>
                                        <a href="@Url.Action("Index", "SanPham", new { hang = "Yonex", loai = "Vot", ten = "Nanoflare" })">Vợt Yonex Nanoflare</a>
                                        <a href="@Url.Action("Index", "SanPham", new { hang = "Yonex", loai = "Vot", ten = "Arcsaber" })">Vợt Yonex Arcsaber</a>
                                    </div>

                                    <div class="brand-column">
                                        <p class="brand-title"><a href="@Url.Action("Index", "SanPham", new { hang = "Lining", loai = "Vot" })">VỢT LINING</a></p>
                                        <a href="@Url.Action("Index", "SanPham", new { hang = "Lining", loai = "Vot", ten = "Aeronaut" })">Vợt Lining Aeronaut</a>

                                        <a href="@Url.Action("Index", "SanPham", new { hang = "Lining", loai = "Vot", ten = "Tectonic" })">Vợt Lining Tectonic</a>
                                        <a href="@Url.Action("Index", "SanPham", new { hang = "Lining", loai = "Vot", ten = "Axforce" })">Vợt Lining Axforce</a>

                                    </div>

                                    <div class="brand-column">
                                        <p class="brand-title"><a href="@Url.Action("Index", "SanPham", new { hang = "Victor", loai = "Vot" })">VỢT VICTOR</a></p>
                                        <a href="@Url.Action("Index", "SanPham", new { hang = "Victor", loai = "Vot", ten = "Auraspeed" })">Vợt Victor Auraspeed</a>

                                        <a href="@Url.Action("Index", "SanPham", new { hang = "Victor", loai = "Vot", ten = "Thruster" })">Vợt Victor Thruster</a>
                                        <a href="@Url.Action("Index", "SanPham", new { hang = "Victor", loai = "Vot", ten = "Jetspeed" })">Vợt Victor Jetspeed</a>

                                    </div>

                                    <div class="brand-column">
                                        <p class="brand-title"><a href="@Url.Action("Index", "SanPham", new { hang = "Mizuno", loai = "Vot" })">VỢT MIZUNO</a></p>

                                        <a href="@Url.Action("Index", "SanPham", new { hang = "Mizuno", loai = "Vot", ten = "Fortius" })">Vợt Mizuno Fortius</a>
                                        <a href="@Url.Action("Index", "SanPham", new { hang = "Mizuno", loai = "Vot", ten = "Altius" })">Vợt Mizuno Altius</a>

                                    </div>
                                </div>
                            </div>


                            <div class="mega-content" data-loai="AoQuan">
                                <div class="product-brands-grid">

                                    <div class="brand-column">
                                        <p class="brand-title"><a href="@Url.Action("Index", "SanPham", new { hang = "Yonex", loai = "AoQuan" })">ÁO QUẦN YONEX</a></p>

                                    </div>

                                    <div class="brand-column">
                                        <p class="brand-title"><a href="@Url.Action("Index", "SanPham", new { hang = "Lining", loai = "AoQuan" })">ÁO QUẦN LINING</a></p>

                                    </div>

                                    <div class="brand-column">

                                        <p class="brand-title"><a href="@Url.Action("Index", "SanPham", new { hang = "Victor", loai = "AoQuan" })">ÁO QUẦN VICTOR</a></p>
                                    </div>


                                    <div class="brand-column">
                                        <p class="brand-title"><a href="@Url.Action("Index", "SanPham", new { hang = "Mizuno", loai = "AoQuan" })">ÁO QUẦN MIZUNO</a></p>
                                    </div>
                                </div>

                            </div>

                            <div class="mega-content" data-loai="PhuKien">

                                <div class="product-brands-grid">
                                    <div class="brand-column">
                                        <p class="brand-title">PHỤ KIỆN CẦU LÔNG</p>

                                        <a href="@Url.Action("Index", "SanPham", new { loai = "PhuKien", ten = "Túi đựng vợt" })">Túi đựng vợt</a>
                                        <a href="@Url.Action("Index", "SanPham", new { loai = "PhuKien", ten = "Dây cuốn cán" })">Dây cuốn cán</a>

                                        <a href="@Url.Action("Index", "SanPham", new { loai = "PhuKien", ten = "Balo cầu lông" })">Balo cầu lông</a>
                                    </div>

                                </div>
                            </div>
                        </div>
                    </div>

                </li>

                <li><a href="@Url.Action("Index", "KhuyenMai")">KHUYẾN MÃI</a></li>
                <li><a href="@Url.Action("ViewCart", "Home")">GIỎ HÀNG</a></li>
                <li><a href="@Url.Action("Index", "DonHang")">ĐƠN HÀNG</a></li>
                <li><a href="@Url.Action("Contact", "Home")">LIÊN HỆ</a></li>
            </ul>

        </nav>
    </header>

    <div class="container">
        <main>
            @if (TempData["Message"] != null)
            {
                <div class="alert alert-info">
                    @TempData["Message"]
                </div>

            }
            @if (TempData["Error"] != null)
            {
                <div class="alert alert-danger">
                    @TempData["Error"]
                </div>

            }
            @RenderBody()
        </main>
    </div>

    <footer>
        <div class="footer-content">
            <div class="footer-section">
                <h4>THÔNG TIN LIÊN HẸ</h4>
                <p><i class="fa-solid fa-location-dot"></i>140 Lê Trọng Tấn, Tây Thạnh, Tân Phú, TP.HCM</p>

                <p><i class="fa-solid fa-phone"></i>0123456789</p>
                <p><i class="fa-solid fa-envelope"></i>HUIT@gmail.com</p>
            </div>
            <div class="footer-section">
                <h4>DANH MỤC SẢN PHẨM</h4>
                <a href="@Url.Action("Index", "SanPham", new { loai = "Vot" })">Vợt cầu lông</a>
                <a href="@Url.Action("Index", "SanPham", new { loai = "Giay" })">Giày cầu lông</a>
                <a href="@Url.Action("Index", "SanPham", new { loai = "AoQuan" })">Áo quần thể thao</a>
                <a href="@Url.Action("Index", "SanPham", new { loai = "PhuKien" })">Phụ kiện cầu lông</a>
            </div>

            <div class="footer-section">
                <h4>HỖ TRỢ KHÁCH HÀNG</h4>
                <a href="@Url.Action("Index", "Home")">Hướng dẫn mua hàng</a>
                <a href="@Url.Action("Index", "Home")">Chính sách bảo hành</a>
                <a href="@Url.Action("Index", "Home")">Chính sách đổi trả</a>

                <a href="@Url.Action("Index", "Home")">Câu hỏi thường gặp</a>
            </div>
        </div>
        <div class="footer-bottom">
            <p>
                &copy;
                2025 - HỆ THỐNG QUẢN LÝ BÁN HÀNG CẦU LÔNG
            </p>
        </div>
    </footer>
    <button id="chat-toggle-btn" class="btn btn-primary rounded-circle shadow-lg"
            style="position: fixed; bottom: 30px; right: 30px; z-index: 9999; width: 60px; height: 60px; border: none; font-size: 24px;">
        <i class="fa fa-comments"></i>
    </button>

    <div id="chat-container" class="card shadow-lg"
         style="position: fixed; bottom: 100px; right: 30px; z-index: 9999; width: 380px; height: 500px; display: none; flex-direction: column; overflow: hidden; border-radius: 15px;">

        <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center" style="flex-shrink: 0;">
            <h6 class="mb-0 font-weight-bold chat-header-title d-flex align-items-center">
                <img class="chat-header-avatar rounded-circle shadow-sm"
                     src="@Url.Content("~/Content/images/HUIT.jpg")"
                     alt="HUIT"
                     style="width: 35px; height: 35px; object-fit: cover; margin-right: 10px;" />
                Trợ lý Cầu Lông
            </h6>
            <button id="close-chat" class="btn btn-sm btn-link text-white" style="text-decoration: none; font-size: 20px;">&times;</button>
        </div>

        <div class="card-body" id="chat-history" style="flex-grow: 1; overflow-y: auto; background-color: #f8f9fa; padding: 15px;">
            <div class="text-muted text-center small my-2">
                Chào bạn! Tôi có thể giúp gì về vợt, giày hay quần áo cầu lông hôm nay?
            </div>
        </div>

        <div class="card-footer bg-white" style="flex-shrink: 0; padding: 10px;">
            <div class="input-group">
                <input type="text" id="user-input" class="form-control" placeholder="Nhập câu hỏi..." style="border-radius: 20px 0 0 20px;">
                <div class="input-group-append">
                    <button id="send-btn" class="btn btn-primary" style="border-radius: 0 20px 20px 0;">
                        <i class="fa fa-paper-plane"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="@Url.Content("~/Scripts/jquery-3.7.0.min.js")"></script>
    <script src="@Url.Content("~/Scripts/bootstrap.js")"></script>

    <script>
        $(document).ready(function () {
            // Ẩn/Hiện khung chat
            $("#chat-toggle-btn, #close-chat").click(function () {
                $("#chat-container").toggle();
                // Focus vào ô nhập liệu khi mở
                if ($("#chat-container").is(":visible")) {
                    $("#user-input").focus();
                }
            });

            // Hàm gửi tin nhắn
            function sendMessage() {
                var message = $("#user-input").val();
                if (message.trim() === "") return;

                // Hiển thị tin người dùng
                $("#chat-history").append(`
                        <div class=\"d-flex justify-content-end mb-2\">\r\n                            <div class=\"bg-primary text-white p-2 rounded\" style=\"max-width: 80%; word-wrap: break-word;\">\r\n                                ${message}\r\n                            </div>\r\n                        </div>\r\n                    `);
                $("#user-input").val("");
                scrollToBottom();

                // Hiển thị trạng thái đang nhập
                $("#chat-history").append('<div id=\"loading\" class=\"text-muted small ml-2\"><i>Đang trả lời...</i></div>');
                scrollToBottom();

                // Gửi Ajax
                $.ajax({
                    url: '/Chatbot/Ask',
                    type: 'POST',
                    data: { message: message },
                    success: function (response) {
                        $("#loading").remove();

                        var botHtml = '';
                        if (response.success) {
                            // Xử lý xuống dòng cho đẹp
                            var botText = response.reply.replace(/\n/g, "<br>");
                            botHtml = `
                                    <div class=\"d-flex justify-content-start mb-2\">\r\n                                        <div class=\"bg-light text-dark border p-2 rounded\" style=\"max-width: 85%; word-wrap: break-word;\">\r\n                                            ${botText}\r\n                                        </div>\r\n                                    </div>`;
                        } else {
                            // Hiển thị lỗi chi tiết để debug
                            botHtml = `<div class=\"text-danger small my-2\">Error: ${response.reply}</div>`;
                        }

                        $("#chat-history").append(botHtml);
                        scrollToBottom();
                    },
                    error: function (xhr, status, error) {
                        $("#loading").remove();
                        $("#chat-history").append('<div class=\"text-danger small my-2\">Lỗi kết nối server: ' + error + '</div>');
                        scrollToBottom();
                    }
                });
            }

            function scrollToBottom() {
                var chatHistory = document.getElementById("chat-history");
                chatHistory.scrollTop = chatHistory.scrollHeight;
            }

            $("#send-btn").click(sendMessage);
            $("#user-input").keypress(function (e) {
                if (e.which == 13) sendMessage();
            });
        });

        $(document).ready(function () {
            // Mega menu logic với delay khi rời chuột
            let hoverTimeout;
            let submenuHovered = false;

             let menuHovered = false;
            const HOVER_DELAY = 300; // 0.3s

            // Chuyển đổi nội dung mega menu
            function switchMegaMenuContent(activeElement) {
                const loai = $(activeElement).data('loai');
                if ($(activeElement).hasClass('active')) return;

                 $('.main-cat').removeClass('active');
                $('.mega-content').removeClass('active');
                $(activeElement).addClass('active');
                $(`.mega-content[data-loai="${loai}"]`).addClass('active');
            }

            // Hover vào từng danh mục bên trái

         $('.main-cat').on('mouseenter', function () {
                switchMegaMenuContent(this);
 });

            // Xử lý hover vào vùng menu cha
            $('.mega-menu-item').on('mouseenter', function () {
                menuHovered = true;
                clearTimeout(hoverTimeout);
                $('.mega-submenu').css({ display: 'flex', opacity: 1, pointerEvents: 'auto' });
            });
 $('.mega-menu-item').on('mouseleave', function () {
                menuHovered = false;
                hoverTimeout = setTimeout(function () {
                    if (!submenuHovered) {
                        $('.mega-submenu').css({ display: 'none', opacity: 0, pointerEvents: 'none' });

                                   }
                }, HOVER_DELAY);
            });
 // Xử lý hover vào vùng mega-submenu
            $('.mega-submenu').on('mouseenter', function () {
                submenuHovered = true;
                clearTimeout(hoverTimeout);
            });
 $('.mega-submenu').on('mouseleave', function () {
                submenuHovered = false;
                hoverTimeout = setTimeout(function () {
                    if (!menuHovered) {
                        $('.mega-submenu').css({ display: 'none', opacity: 0, pointerEvents: 'none' });

                                   }
                }, HOVER_DELAY);
            });


            $('.user-btn').click(function (e) {
                e.stopPropagation();
                $(this).siblings('.user-menu').toggleClass('show');
            });
 $(document).click(function () {
                $('.user-menu').removeClass('show');
            });

            function updateCartCount() {
                try {
                    $.get('@Url.Action("GetCartCount", "GioHang")')
                        .done(function (data) {

                 $('.cart-count').text(data);
                        });
 } catch (e) { }
            }
            updateCartCount();
        });
    </script>

    @RenderSection("scripts", required: false)
</body>
</html>